
set -x

# =============================================================

### SECURITY HARDENING:

cd /root || exit 1;
ls || exit 1;

# =============================================================

# Harden sshd configuration
# Remove the old keys
rm -rf /etc/ssh/ssh_host_*
# Generate new secure key
ssh-keygen -o -a 100 -t ed25519 -C "cmeldis" -f /etc/ssh/ssh_host_ed25519_key -N ""
# Generate new Diffie-Hellman moduli (!! 15-30 minutes !! then 5-10 HOURS !! )
ssh-keygen -G moduli-4096.candidates -b 512
# ssh-keygen -G moduli-4096.candidates -b 4096
ssh-keygen -T moduli-4096 -f moduli-4096.candidates
cp moduli-4096 /etc/ssh/moduli
rm moduli-4096



# Allow only the most secure algorithms in the /etc/ssh/sshd_config
cat << EOF > /etc/ssh/sshd_config
Ciphers=aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr
MACs=hmac-sha2-512-etm@openssh.com
KexAlgorithms=curve25519-sha256@libssh.org,diffie-hellman-group14-sha256,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512
HostKeyAlgorithms=ssh-ed25519,ssh-ed25519-cert-v01@openssh.com
PubkeyAcceptedKeyTypes=ssh-ed25519,ssh-ed25519-cert-v01@openssh.com
CASignatureAlgorithms=ssh-ed25519
hostbasedacceptedkeytypes=ssh-ed25519-cert-v01@openssh.com,ssh-ed25519

X11Forwarding no
IgnoreRhosts yes
UseDNS yes
PermitEmptyPasswords no

PubkeyAuthentication yes
PasswordAuthentication no
PermitRootLogin prohibit-password

Protocol 2
Port 23253

ClientAliveInterval 3000
ClientAliveCountMax 5

GSSAPIAuthentication no
permitopen none
permitlisten none
allowtcpforwarding no
allowagentforwarding no
disableforwarding yes
allowstreamlocalforwarding no
PermitTTY yes
permituserrc no
PrintLastLog no

UsePAM yes
EOF

# ssh key to access root
mkdir -p /root/.ssh
chmod og-rwx /root/.ssh
cat << EOF > /root/.ssh/authorized_keys
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINtORHCAMaWVMxdZmdCGkB73v07xhzF/vYwfxGrK7Q/I
EOF
chmod og-rwx /root/.ssh/authorized_keys

# ENABLE FIREWALL
systemctl enable firewalld
systemctl start firewalld

# Allow ssh port in firewall
firewall-cmd --zone=public --add-port=23253/tcp --permanent

# Allow ssh port in SELinux
dnf install -y /usr/sbin/semanage
semanage boolean -m --on nis_enabled

# APPLY FIREWALL CHANGES
systemctl restart firewalld

# ENABLE SSHD
systemctl enable sshd
systemctl restart sshd


# Certificate
cat << EOF > /tmp/ssh_cert.ovpn
client
dev tun
remote 89.238.166.234 443
resolv-retry infinite
nobind
persist-key
persist-tun
auth-nocache
route-delay 5
verb 3
remote-cert-tls server
cipher AES-256-CBC
comp-lzo no
proto tcp
key-direction 1
<ca>
-----BEGIN CERTIFICATE-----
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
-----END CERTIFICATE-----
</ca>
<cert>
-----BEGIN CERTIFICATE-----
MIIGujCCBKKgAwIBAgIDAxXNMA0GCSqGSIb3DQEBDQUAMHkxCzAJBgNVBAYTAklU
MQswCQYDVQQIEwJJVDEQMA4GA1UEBxMHUGVydWdpYTETMBEGA1UEChMKYWlydnBu
Lm9yZzEWMBQGA1UEAxMNYWlydnBuLm9yZyBDQTEeMBwGCSqGSIb3DQEJARYPaW5m
b0BhaXJ2cG4ub3JnMB4XDTE5MTAwOTEwMjMxOVoXDTI5MTAwNjEwMjMxOVowgZQx
CzAJBgNVBAYTAklUMQswCQYDVQQIEwJJVDEQMA4GA1UEBxMHUGVydWdpYTETMBEG
A1UEChMKYWlydnBuLm9yZzExMC8GA1UEAxMoOWNiYmIwZWE0NDExNjA2MjAwNzY0
YTg4NjUxYTc3YWIwZGIwZDkxMzEeMBwGCSqGSIb3DQEJARYPaW5mb0BhaXJ2cG4u
b3JnMIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEA3xKaqTjXbhliXrQ5
xYHA10H9D3E0sgkB9N26oVdKgAfrEjzaumQ4yOTyeAAhWLwVKTcOexRYSZq5o8jc
jmigZDPvCDYqARzAmZu+18wzloAUk5ixJ1NfVbrYMuogNTaT+sohXgCx8sVSknrw
TuWxFSaOzYUsWjMrG6inOdSlD7k0/tfH4TIHLyeOG43cuU79+U9u7YbiORBA6ypF
GWPPaRtuz/Ff8tucUhXQpemF/X20uSY6TAnKantlfz7hrAh2KxBhsEOAZrWYme8K
hdwvT0J1nVxjDsM7rYPUCmAAE+p3MOn8PBzWULxKze2SkD+Z6TvAcGuZu4rR3mFQ
nPW5v1Uac9fgZAxQWoyQuWVsriyM/34mPtGqh/OZ3Y/YDBKrTvSecCv5bjrf4jLF
E37AIoYw8y3zeLcO2Yp2JIM+MKlQ6k+VnqglsCm2wm0zxR4IHV7el0dpHIFIRIjV
4JVlKX5BTa2WRfAcg7fCqZueuXkryM6Oq819Gv0MbWwnE5q9PKvLzI/9dSxzn7sI
7GWJfb9KD2Ep8Qsb35SyA/OOxvw5zbHe0tF+PwOccNI6KeMOu4YfkQZ1lrycIj6W
cNBMwlmyi2WbymONhVs21CQU8ySwQGXojTOYdH6S9Y9ggtyB1QezBYKHALanct2E
cuQkM7asv1XeP9cJVSpH238gu88CAwEAAaOCAS0wggEpMAkGA1UdEwQCMAAwLQYJ
YIZIAYb4QgENBCAWHkVhc3ktUlNBIEdlbmVyYXRlZCBDZXJ0aWZpY2F0ZTAdBgNV
HQ4EFgQUbHlQyO5lNaxK5DGCC8dCbDdxnFswgasGA1UdIwSBozCBoIAUnORg2W83
6M8uVFUyxdjZAL6NeAOhfaR7MHkxCzAJBgNVBAYTAklUMQswCQYDVQQIEwJJVDEQ
MA4GA1UEBxMHUGVydWdpYTETMBEGA1UEChMKYWlydnBuLm9yZzEWMBQGA1UEAxMN
YWlydnBuLm9yZyBDQTEeMBwGCSqGSIb3DQEJARYPaW5mb0BhaXJ2cG4ub3JnggkA
wmQoonZSjWcwEwYDVR0lBAwwCgYIKwYBBQUHAwIwCwYDVR0PBAQDAgeAMA0GCSqG
SIb3DQEBDQUAA4ICAQBMZqOaaOl3pkyVvWxYZ+6J+2OUeP22n4Op5E9S0gGfIZhG
c/H1h8OkjF2ZlNXmPOgdfl6Tqg3peJb/kWwihIiJsqpDOxEEfq1gmBDd88NiDtUM
5cylSQlV72py5WfEkchwNz4KHsz1eKldarsk0tm9vzn23kj6ie9zfQMXRfQmbEuV
Iir4WDqT1RNLdOebitbCTsWXVnR/SKJgf1SyoD/Qe5vdaYmhm3boAMj/z0ubkUX5
hv4jwukNiLW9aYuvzJ737p5Y0R7OuWJoq0bsHP0J17LDSC3fM8qCNn+8rXZIkFsM
/W4PTLCCbZm6afjf/KjGX7+h908ZLh5lzAIEDNBJn8pC4fgf31eF7E+Zos470LrS
PzgQytZ3ZZAvbOGAS/6fL0qtoLvl4gH7PH4NCqUy5FHpFv+qjyIunIgl6kOEQhua
KkRs3nmLKN/u1LfbsUYUGC05iz+1OocaaU5xH60fGWMSMMopnuDK1dqhZweSRqk7
ovC8XlMj6fpuarsMwdPAR9huZf4MxO+CJk+1QUZDMR2P5MOfpKS1rTKgex3+iV//
m8gipCKVj7v47JXORnSNvwylRsOGxW90a6Tvhn79BpMK01y5lewBlfjC7U8z5S7I
LhLi1SQWclWsd9p8RI8XflTzimTKBxMKoCkdZ4afrK3u/Aowmdm2OiRG/HvCbA==
-----END CERTIFICATE-----
</cert>
<key>
-----BEGIN PRIVATE KEY-----
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
2lJ+hmYmABmWaLR0QAjdFY4mUNI2EM0=
-----END PRIVATE KEY-----
</key>
<tls-auth>
#
# 2048 bit OpenVPN static key
#
-----BEGIN OpenVPN Static key V1-----
7bb7a23a0f5f28d01e792df68f1764ab
f2688719288808bf58e8a2d4f9354ecf
132625dfb895fc3f6330ae1e868e4dfa
c164c0931593d7f9a7da9595cf353433
8896e1d0a987a0d19838944af8fea4e5
215a3a0c76f4c67d5a4aee6a53be66a4
c88b84f850030840fb30f8550ed8068f
35c1ef34ee8f40a0ea5862dfb6f8d3c5
7ab5e27ac2799cf93e8765ff63cd8cd8
6b391b813925cd373bb202796f64d16f
003d042ca828d1b07f18ba1d0cb0323d
df3ee9287e9e084e655699efb3cffa92
3626946fa372e7beee245e7a95b4c1d8
7d16cae685218d4b8afc019b22e41083
476ee9883fe666d236301e55b2062551
4d91c8a69467a758293994df1e6fa7ae
-----END OpenVPN Static key V1-----
</tls-auth>
EOF

dnf install -y openvpn NetworkManager-openvpn /usr/bin/audit2allow

echo "" > /var/log/audit/audit.log
setenforce 0
nmcli connection import type openvpn file /tmp/ssh_cert.ovpn
nmcli connection up ssh_cert
setenforce 1
audit2allow -a -b -M ssh
semodule -i ssh.pp

